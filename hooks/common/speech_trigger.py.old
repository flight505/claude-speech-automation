#!/usr/bin/env python3
"""Speech trigger utility for generating hook outputs."""

import json
import sys
from typing import Dict, Any


def trigger_speech(
    message: str,
    voice: str = "af_bella",
    speed: float = 1.0,
    priority: int = 0,
    event_type: str = "unknown"
) -> None:
    """
    Trigger automatic speech by outputting special system message.

    Claude Code will interpret this output and call the text_to_speech tool.

    Args:
        message: Text to speak
        voice: Voice ID (default: af_bella)
        speed: Speech speed multiplier (default: 1.0)
        priority: Priority score for debugging (default: 0)
        event_type: Event classification for debugging (default: unknown)
    """
    # Format: [AUTO-SPEECH] followed by JSON payload
    payload = {
        "action": "speak",
        "text": message,
        "voice": voice,
        "speed": speed,
        "priority": priority,
        "event_type": event_type
    }

    # Output to stdout for Claude Code to interpret
    output = f"[AUTO-SPEECH] {json.dumps(payload)}"
    print(output, file=sys.stdout, flush=True)


def log_debug(message: str, data: Dict[str, Any] = None) -> None:
    """
    Log debug information to stderr (won't interfere with hook output).

    Args:
        message: Debug message
        data: Optional data to include in log
    """
    log_entry = {
        "level": "debug",
        "message": message,
        "data": data or {}
    }

    print(f"[HOOK-DEBUG] {json.dumps(log_entry)}", file=sys.stderr, flush=True)


def log_error(message: str, error: Exception = None) -> None:
    """
    Log error information to stderr.

    Args:
        message: Error message
        error: Optional exception to include
    """
    log_entry = {
        "level": "error",
        "message": message,
        "error": str(error) if error else None
    }

    print(f"[HOOK-ERROR] {json.dumps(log_entry)}", file=sys.stderr, flush=True)


def should_speak(
    priority: int,
    min_priority: int,
    enabled: bool,
    event_enabled: bool
) -> bool:
    """
    Determine if speech should be triggered based on configuration.

    Args:
        priority: Calculated priority score
        min_priority: Minimum priority threshold from config
        enabled: Global automation enabled flag
        event_enabled: Event-specific enabled flag

    Returns:
        True if speech should be triggered
    """
    # Check global enable
    if not enabled:
        return False

    # Check event-specific enable
    if not event_enabled:
        return False

    # Check priority threshold
    if priority < min_priority:
        return False

    return True
